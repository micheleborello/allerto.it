<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz VVF - Admin Test </title>
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --accent:#ea580c; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --light:#f1f5f9; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI","Helvetica Neue",Arial,sans-serif; background: radial-gradient(circle at 20% 20%, #e2e8f0 0, #f8fafc 60%); color: var(--text); }
    .app { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 12px; }
    h1 { margin: 0; font-weight: 700; letter-spacing: 0.3px; }
    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
    button { border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; background: var(--accent); color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,0.12); transition: transform 120ms ease, filter 120ms ease; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.02); }
    input, select { width: 100%; padding: 9px; border-radius: 8px; border: 1px solid var(--border); background: #fff; color: var(--text); }
    .small { color: var(--muted); font-size: 13px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; }
    .builder { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .question-card { border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card); box-shadow:0 6px 14px rgba(0,0,0,0.08); margin-bottom:10px; }
    .test-list { list-style:none; padding:0; margin:0; display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:10px; }
    .test-item { border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card); box-shadow:0 8px 16px rgba(0,0,0,0.08); position:relative; }
    .test-item .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .badge { background: var(--light); border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Gestione Test (Admin)</h1>
      <button id="go-classes" style="background:#0ea5e9; color:#0f172a;">Gestione classi</button>
      <button id="go-users" style="background:#22c55e; color:#0f172a;">Gestione utenti</button>
    </header>

    <div id="status" class="small"></div>

    <div class="panel">
      <strong>Crea/Modifica test</strong>
      <div class="small">Scegli il numero di domande, genera dal pool o modifica quelle esistenti.</div>
      <div class="grid" style="margin-top:8px;">
        <div>
          <label for="question-count">Numero di domande</label>
          <input id="question-count" type="number" min="1" max="100" value="30" />
        </div>
        <div>
          <label for="test-title">Titolo test</label>
          <input id="test-title" placeholder="Titolo test" />
        </div>
        <div>
          <label for="source-select">Sorgente domande</label>
          <select id="source-select" multiple size="6"></select>
        </div>
        <div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
          <button id="generate">Genera domande</button>
          <button id="regen" disabled style="background:#f59e0b; color:#0f172a;">Rigenera non bloccate</button>
          <button id="save-test" disabled>Salva test</button>
        </div>
      </div>
      <div id="quiz"></div>
    </div>

    <div class="panel">
      <strong>Test salvati</strong>
      <div class="small">Apri, modifica o elimina un test esistente.</div>
      <ul id="tests-list" class="test-list"></ul>
    </div>

    <div class="panel">
      <strong>Gestione video (Admin)</strong>
      <div class="small">Carica un video e pubblicalo. Istruzione/assegnazione avviene in classes.html.</div>
      <div class="grid" style="margin-top:8px;">
        <div>
          <label class="small" for="video-title">Titolo video</label>
          <input id="video-title" placeholder="Titolo video">
        </div>
        <div>
          <label class="small" for="video-descr">Descrizione</label>
          <input id="video-descr" placeholder="Descrizione breve">
        </div>
        <div>
          <label class="small" for="video-file">File video (mp4/mov/webm/mkv)</label>
          <input id="video-file" type="file" accept=".mp4,.mov,.webm,.mkv">
        </div>
        <div>
          <label class="small" for="video-url">Oppure link video (URL)</label>
          <input id="video-url" type="url" placeholder="https://...">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button id="upload-video" style="background:#22c55e; color:#0f172a;">Carica video</button>
        </div>
      </div>
      <div id="video-msg" class="small" style="margin-top:6px;"></div>
      <div class="small" style="margin-top:10px;"><strong>Video pubblicati</strong></div>
      <div id="video-list" class="test-list"></div>
    </div>

    <div class="panel">
      <strong>Materiale didattico (Admin)</strong>
      <div class="small">Carica file (pdf/doc/immagini) e assegnali alle classi da classes.html.</div>
      <div class="grid" style="margin-top:8px;">
        <div>
          <label class="small" for="material-title">Titolo materiale</label>
          <input id="material-title" placeholder="Titolo materiale">
        </div>
        <div>
          <label class="small" for="material-descr">Descrizione</label>
          <input id="material-descr" placeholder="Descrizione breve">
        </div>
        <div>
          <label class="small" for="material-file">File (pdf/doc/xls/ppt/immagini)</label>
          <input id="material-file" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.odt,.odp,.png,.jpg,.jpeg,.webp,.txt,.rtf,.csv">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button id="upload-material" style="background:#3b82f6; color:#0f172a;">Carica materiale</button>
        </div>
      </div>
      <div id="material-msg" class="small" style="margin-top:6px;"></div>
      <div class="small" style="margin-top:10px;"><strong>Materiali caricati</strong></div>
      <div id="material-list" class="test-list"></div>
    </div>
  </div>

  <script>
    const STORAGE_TESTS = "vvf_tests";
    const STORAGE_RESULTS = "vvf_results";
    const STORAGE_STUDENTS = "vvf_students";
    const STORAGE_REQUESTS = "vvf_requests";
    const STORAGE_VIDEOS = "vvf_videos";
    const STORAGE_MATERIALS = "vvf_materials";
    const API_URL = "save_data.php";
    const API_TOKEN = "ALLERTO";
    const statusEl = document.getElementById("status");
    const questionCountEl = document.getElementById("question-count");
    const titleEl = document.getElementById("test-title");
    const sourceSelect = document.getElementById("source-select");
    const generateBtn = document.getElementById("generate");
    const regenBtn = document.getElementById("regen");
    const saveBtn = document.getElementById("save-test");
    const quizEl = document.getElementById("quiz");
    const testsList = document.getElementById("tests-list");
    const goClasses = document.getElementById("go-classes");
    const goUsers = document.getElementById("go-users");
    const videoList = document.getElementById("video-list");
    const videoTitle = document.getElementById("video-title");
    const videoDescr = document.getElementById("video-descr");
    const videoFile = document.getElementById("video-file");
    const videoUrl = document.getElementById("video-url");
    const videoMsg = document.getElementById("video-msg");
    const uploadBtn = document.getElementById("upload-video");
    const materialList = document.getElementById("material-list");
    const materialTitle = document.getElementById("material-title");
    const materialDescr = document.getElementById("material-descr");
    const materialFile = document.getElementById("material-file");
    const materialMsg = document.getElementById("material-msg");
    const uploadMatBtn = document.getElementById("upload-material");

    const sources = [
      { key: "Aerop", path: "assets/Aerop.csv", label: "Aerop" },
      { key: "AIB", path: "assets/AIB.csv", label: "AIB" },
      { key: "ATP", path: "assets/ATP.csv", label: "ATP" },
      { key: "Attrezzature", path: "assets/Attrezzature.csv", label: "Attrezzature" },
      { key: "Cartografia", path: "assets/Cartografia.csv", label: "Cartografia" },
      { key: "CD", path: "assets/CD.csv", label: "CD" },
      { key: "Chimica", path: "assets/Chimica.csv", label: "Chimica" },
      { key: "Classe5B", path: "assets/Classe5B.csv", label: "Classe5B" },
      { key: "Dpi", path: "assets/Dpi.csv", label: "DPI" },
      { key: "Elettrotecnica", path: "assets/Elettrotecnica.csv", label: "Elettrotecnica" },
      { key: "Ginnica", path: "assets/Ginnica.csv", label: "Ginnica" },
      { key: "Idraulica", path: "assets/Idraulica.csv", label: "Idraulica" },
      { key: "NBCR", path: "assets/NBCR.csv", label: "NBCR" },
      { key: "Organiz", path: "assets/Organiz.csv", label: "Organiz" },
      { key: "PoliziaGiudiziaria", path: "assets/PoliziaGiudiziaria.csv", label: "Polizia Giudiziaria" },
      { key: "Pos", path: "assets/Pos.csv", label: "POS" },
      { key: "PrevIncendi", path: "assets/PrevIncendi.csv", label: "Prev. Incendi" },
      { key: "Quizzone", path: "assets/Quizzone.csv", label: "Quizzone" },
      { key: "SAF", path: "assets/SAF.csv", label: "SAF" },
      { key: "SostEstinguenti", path: "assets/SostEstinguenti.csv", label: "Sost. Estinguenti" },
      { key: "SostPericolose", path: "assets/SostPericolose.csv", label: "Sost. Pericolose" },
      { key: "TPSS", path: "assets/TPSS.csv", label: "TPSS" },
      { key: "Tutte", path: "assets/Tutte.csv", label: "Generale" },
      { key: "Usar", path: "assets/Usar.csv", label: "USAR" },
    ];

    let savedTests = loadJSON(STORAGE_TESTS, []);
    let savedResults = loadJSON(STORAGE_RESULTS, []);
    let students = loadJSON(STORAGE_STUDENTS, []);
    let requests = loadJSON(STORAGE_REQUESTS, []);
    let videos = loadJSON(STORAGE_VIDEOS, []);
    let materials = loadJSON(STORAGE_MATERIALS, []);
    const state = { questions: [], pool: [], locked: new Set(), currentTestId: null };

    const uuid = ()=> crypto.randomUUID ? crypto.randomUUID() : 'v_'+Math.random().toString(36).slice(2);

    init();

    function setStatus(msg){ statusEl.textContent = msg; }
    function escapeHTML(str){ return str.replace(/[&<>"']/g, ch => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[ch])); }
    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
    function decodeBuffer(buf) { const utf8 = new TextDecoder("utf-8").decode(buf); const iso = new TextDecoder("iso-8859-1").decode(buf); const score = str => (str.match(/[????]/g) || []).length; return score(utf8) <= score(iso) ? utf8 : iso; }
    async function fetchCsv(path) { const res = await fetch(path); if (!res.ok) throw new Error(`Impossibile leggere ${path} (${res.status})`); const buf = await res.arrayBuffer(); return decodeBuffer(buf); }
    function parseCsv(text, sourceLabel) { return text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && l.includes(";")).map(line=>{ const cells=line.split(";").map(c=>c.trim()); const question=cells[2]||""; const options=cells.slice(3).filter(c=>c && !/^-+$/.test(c) && !/^[0-9]+$/.test(c)); const numeric=cells.slice(3).find(c=>/^[1-5]$/.test(c)); const answerIndex=numeric?Number(numeric)-1:0; return (question && options.length)?{question,options,answerIndex,source:sourceLabel}:null; }).filter(Boolean); }
    function pickQuestions(pool, count) { return shuffle([...pool]).slice(0, Math.min(count, pool.length)); }
    function keyOf(q) { return `${q.source}|${q.question}`; }
    function isLocked(q) { return state.locked.has(keyOf(q)); }
    function loadJSON(key, fallback) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } }
    function saveJSON(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function ensureArray(val){ return Array.isArray(val) ? val : []; }
    async function loadRemote(type, fallback) {
      if (!API_TOKEN) return fallback;
      try {
        const res = await fetch(`${API_URL}?type=${encodeURIComponent(type)}&token=${encodeURIComponent(API_TOKEN)}`);
        if (!res.ok) throw new Error("Errore rete");
        const json = await res.json();
        if (json && json.data !== undefined) return json.data;
      } catch (err) { console.warn("Load remote", type, err); }
      return fallback;
    }
    async function saveRemote(type, data) {
      if (!API_TOKEN) return;
      try {
        await fetch(`${API_URL}?type=${encodeURIComponent(type)}&token=${encodeURIComponent(API_TOKEN)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
      } catch (err) { console.warn("Save remote", type, err); }
    }
    async function init() {
      savedTests = ensureArray(await loadRemote("vvf_tests", savedTests));
      savedResults = ensureArray(await loadRemote("vvf_results", savedResults));
      students = ensureArray(await loadRemote("vvf_students", students));
      requests = ensureArray(await loadRemote("vvf_requests", requests));
      videos = ensureArray(await loadRemote("vvf_videos", videos));
      materials = ensureArray(await loadRemote("vvf_materials", materials));
      saveJSON(STORAGE_TESTS, savedTests);
      saveJSON(STORAGE_RESULTS, savedResults);
      saveJSON(STORAGE_STUDENTS, students);
      saveJSON(STORAGE_REQUESTS, requests);
      saveJSON(STORAGE_VIDEOS, videos);
      saveJSON(STORAGE_MATERIALS, materials);
      renderSaved();
      renderSources();
      renderVideos();
      renderMaterials();
    }

    function renderSources(){
      sourceSelect.innerHTML = sources.map(s=>`<option value="${s.key}" selected>${escapeHTML(s.label)}</option>`).join("");
    }
    function renderVideos(){
      if (!videoList) return;
      if (!Array.isArray(videos) || !videos.length) {
        videoList.innerHTML = '<li class="test-item small">Nessun video caricato.</li>';
        return;
      }
      videoList.innerHTML = videos.map(v=>`
        <li class="test-item">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <div>
              <strong>${escapeHTML(v.title||'')}</strong><br>
              <span class="small">${escapeHTML(v.descr||'')}</span>
            </div>
            <span class="badge">${(v.assigned_classes||[]).length} classi</span>
          </div>
          <div class="small">File: ${escapeHTML(v.url||'')}</div>
          <div class="small" style="margin-top:4px;">Caricato da: ${escapeHTML(v.created_by||'')}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button class="btn-small" data-del="${v.id}" style="padding:6px 10px; border-radius:8px; font-size:12px; background:#f87171;">Elimina</button>
          </div>
        </li>
      `).join("");
      videoList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = ()=> deleteVideo(btn.dataset.del);
      });
    }

    async function persistVideos(){
      await saveRemote("vvf_videos", videos);
      saveJSON(STORAGE_VIDEOS, videos);
    }

    async function deleteVideo(id){
      const idx = videos.findIndex(v => String(v.id) === String(id));
      if (idx === -1) return;
      const target = videos[idx];
      if (!confirm(`Eliminare il video "${target.title || id}"?`)) return;
      videos.splice(idx, 1);
      await persistVideos();
      renderVideos();
      videoMsg.textContent = "Video eliminato.";
    }

    function renderMaterials(){
      if (!materialList) return;
      if (!Array.isArray(materials) || !materials.length) {
        materialList.innerHTML = '<li class="test-item small">Nessun materiale caricato.</li>';
        return;
      }
      materialList.innerHTML = materials.map(m=>`
        <li class="test-item">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <div>
              <strong>${escapeHTML(m.title||'')}</strong><br>
              <span class="small">${escapeHTML(m.descr||'')}</span>
            </div>
            <span class="badge">${(m.assigned_classes||[]).length} classi</span>
          </div>
          <div class="small">File: ${escapeHTML(m.url||'')}</div>
          <div class="small" style="margin-top:4px;">Caricato da: ${escapeHTML(m.created_by||'')}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button class="btn-small" data-del="${m.id}" style="padding:6px 10px; border-radius:8px; font-size:12px; background:#f87171;">Elimina</button>
          </div>
        </li>
      `).join("");
      materialList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = ()=> deleteMaterial(btn.dataset.del);
      });
    }

    async function persistMaterials(){
      await saveRemote("vvf_materials", materials);
      saveJSON(STORAGE_MATERIALS, materials);
    }

    async function deleteMaterial(id){
      const idx = materials.findIndex(m => String(m.id) === String(id));
      if (idx === -1) return;
      const target = materials[idx];
      if (!confirm(`Eliminare il materiale "${target.title || id}"?`)) return;
      materials.splice(idx, 1);
      await persistMaterials();
      renderMaterials();
      if(materialMsg) materialMsg.textContent = "Materiale eliminato.";
    }

    async function uploadVideo(){
      if (!uploadBtn) return;
      videos = ensureArray(videos);
      const title = videoTitle.value.trim();
      const descr = videoDescr.value.trim();
      const file = videoFile.files[0];
      const link = videoUrl ? videoUrl.value.trim() : "";
      if (!title || (!file && !link)) { videoMsg.textContent = "Titolo e file o link sono obbligatori."; return; }
      uploadBtn.disabled = true;
      let finalUrl = link;
      if (file) {
        videoMsg.textContent = "Caricamento in corso...";
        const fileSizeMB = Math.round((file.size / 1024 / 1024) * 10) / 10;
        if (fileSizeMB > 0) {
          videoMsg.textContent = `Caricamento in corso... (${fileSizeMB} MB)`;
        }
        const fd = new FormData();
        fd.append("file", file, file.name);
        fd.append("token", API_TOKEN);
        try{
          const up = await fetch("upload_video.php?token="+encodeURIComponent(API_TOKEN), { method:"POST", body: fd });
          const text = await up.text();
          let uj = null;
          try { uj = text ? JSON.parse(text) : null; } catch { uj = null; }
          if (!up.ok) {
            const serverMsg = uj && uj.error ? uj.error : (text ? text.slice(0, 200) : "");
            throw new Error(`HTTP ${up.status}${serverMsg ? ` - ${serverMsg}` : ""}`);
          }
          if (!uj || !uj.ok) throw new Error((uj && uj.error) ? uj.error : "Upload fallito");
          finalUrl = uj.url;
        } catch(err){
          videoMsg.textContent = "Errore: " + err.message + " (verifica i limiti di upload_max_filesize/post_max_size)";
          uploadBtn.disabled = false;
          return;
        }
      }
      videos.push({
        id: uuid(),
        title, descr,
        url: finalUrl,
        created_by: "admin",
        assigned_classes: [],
        views: {}
      });
      await persistVideos();
      videoTitle.value = "";
      videoDescr.value = "";
      videoFile.value = "";
      if(videoUrl) videoUrl.value = "";
      videoMsg.textContent = file ? "Video caricato e salvato." : "Link video salvato.";
      renderVideos();
      uploadBtn.disabled = false;
    }

    async function uploadMaterial(){
      if (!uploadMatBtn) return;
      materials = ensureArray(materials);
      const title = materialTitle.value.trim();
      const descr = materialDescr.value.trim();
      const file = materialFile.files[0];
      if (!title || !file) { materialMsg.textContent = "Titolo e file sono obbligatori."; return; }
      uploadMatBtn.disabled = true;
      materialMsg.textContent = "Caricamento in corso...";
      const fd = new FormData();
      fd.append("file", file, file.name);
      fd.append("token", API_TOKEN);
      try{
        const up = await fetch("upload_material.php?token="+encodeURIComponent(API_TOKEN), { method:"POST", body: fd });
        const text = await up.text();
        let uj = null;
        try { uj = text ? JSON.parse(text) : null; } catch { uj = null; }
        if (!up.ok) {
          const serverMsg = uj && uj.error ? uj.error : (text ? text.slice(0, 200) : "");
          throw new Error(`HTTP ${up.status}${serverMsg ? ` - ${serverMsg}` : ""}`);
        }
        if (!uj || !uj.ok) throw new Error((uj && uj.error) ? uj.error : "Upload fallito");
        const url = uj.url;
        materials.push({
          id: uuid(),
          title, descr,
          url,
          created_by: "admin",
          assigned_classes: []
        });
        await persistMaterials();
        materialTitle.value = "";
        materialDescr.value = "";
        materialFile.value = "";
        materialMsg.textContent = "Materiale caricato e salvato.";
        renderMaterials();
      } catch(err){
        materialMsg.textContent = "Errore: " + err.message + " (verifica i limiti di upload_max_filesize/post_max_size)";
      } finally {
        uploadMatBtn.disabled = false;
      }
    }

    generateBtn.addEventListener("click", loadQuestions);
    regenBtn.addEventListener("click", regenerateUnlocked);
    saveBtn.addEventListener("click", saveCurrentTest);
    goClasses.addEventListener("click", ()=> window.location.href = "classes.html");
    goUsers.addEventListener("click", ()=> window.location.href = "admin-users.html");
    if (uploadBtn) uploadBtn.addEventListener("click", uploadVideo);
    if (uploadMatBtn) uploadMatBtn.addEventListener("click", uploadMaterial);

    async function loadQuestions() {
      const selectedSources = Array.from(sourceSelect.selectedOptions).map(o=>o.value);
      if (!selectedSources.length) { setStatus("Seleziona almeno una sorgente."); return; }
      setStatus("Carico domande...");
      let pool = [];
      for (const key of selectedSources) {
        const src = sources.find(s => s.key === key);
        if (!src) continue;
        try {
          const csv = await fetchCsv(src.path);
          pool = pool.concat(parseCsv(csv, src.label));
        } catch (err) {
          console.warn("CSV", src.path, err);
          setStatus(`Errore caricando ${src.label}`);
        }
      }
      state.pool = pool;
      state.questions = pickQuestions(pool, Number(questionCountEl.value) || 30);
      state.locked.clear();
      state.currentTestId = null;
      renderQuestions(state.questions);
      setStatus(`Caricate ${state.questions.length} domande.`);
      saveBtn.disabled = false;
      regenBtn.disabled = state.pool.length === 0;
    }

    function renderQuestions(list, selectionMap = null) {
      quizEl.innerHTML = "";
      list.forEach((q, idx) => {
        const locked = isLocked(q);
        const card = document.createElement("div");
        card.className = "question-card" + (locked ? " locked" : "");
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="badge">${escapeHTML(q.source)}</div>
            <button type="button" class="btn-lock btn-small" data-idx="${idx}" style="background:${locked?'#16a34a':'#0ea5e9'}; color:#fff;">${locked ? "Sblocco" : "Blocca"}</button>
          </div>
          <div style="margin-top:6px;"><strong>${idx + 1}. ${escapeHTML(q.question)}</strong></div>
          <div class="small">${q.options.map((opt,i)=>`${i+1}) ${escapeHTML(opt)}`).join("<br>")}</div>
          <div class="small" style="margin-top:4px;">Risposta corretta: ${q.answerIndex+1}</div>
        `;
        quizEl.appendChild(card);
      });
      quizEl.querySelectorAll(".btn-lock").forEach(btn=>{
        btn.onclick = ()=>{
          const i = Number(btn.dataset.idx);
          const q = state.questions[i];
          const k = keyOf(q);
          if (state.locked.has(k)) state.locked.delete(k); else state.locked.add(k);
          renderQuestions(state.questions);
        };
      });
    }

    function regenerateUnlocked(){
      if(!state.questions.length) { setStatus("Genera prima le domande."); return; }
      if(!state.pool.length) {
        // se stiamo modificando un test salvato senza pool, usa le domande correnti come pool di rimpiazzo
        state.pool = state.questions.slice();
      }
      const lockedKeys = new Set(state.questions.filter(isLocked).map(keyOf));
      const unlockedIdx = state.questions.map((q, idx) => ({ q, idx })).filter(({ q }) => !isLocked(q)).map(({ idx }) => idx);
      if (!unlockedIdx.length) { setStatus("Nessuna domanda sbloccata da rigenerare."); return; }
      const candidates = shuffle(state.pool.filter(q => !lockedKeys.has(keyOf(q))));
      let ci = 0;
      unlockedIdx.forEach(i => { if (ci < candidates.length) state.questions[i] = candidates[ci++]; });
      renderQuestions(state.questions);
      setStatus("Domande non bloccate rigenerate.");
    }

    function saveCurrentTest() {
      if (!state.questions.length) return;
      const title = titleEl.value.trim() || "Test senza titolo";
      const count = Number(questionCountEl.value) || state.questions.length;
      const questions = state.questions.slice(0, count);
      let test;
      if(state.currentTestId){
        const existing = savedTests.find(t=>t.id===state.currentTestId);
        if(existing){
          existing.title = title;
          existing.questions = questions;
          existing.createdAt = existing.createdAt || Date.now();
          test = existing;
        }
      }
      if(!test){
        test = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()), title, createdAt: Date.now(), questions };
        savedTests.push(test);
        state.currentTestId = test.id;
      }
      persistAll();
      renderSaved();
      setStatus("Test salvato.");
    }

    function renderSaved() {
      testsList.innerHTML = "";
      if (!savedTests.length) { testsList.innerHTML = '<li class="small">Nessun test salvato.</li>'; return; }
      savedTests.forEach(t => {
        const li = document.createElement("li");
        li.className = "test-item";
        const date = new Date(t.createdAt).toLocaleString();
        const count = (savedResults.filter(r => r.testId === t.id).length) || 0;
        li.innerHTML = `<strong>${escapeHTML(t.title)}</strong> <span class="small">(${date})</span> <span class="badge">${count} risultati</span>`;
        const actions = document.createElement("div");
        actions.className = "actions";
        const openBtn = document.createElement("button"); openBtn.className="btn-small"; openBtn.textContent="Apri/Modifica";
        const delBtn = document.createElement("button"); delBtn.className="btn-small"; delBtn.style.background="#f87171"; delBtn.textContent="Elimina";
        openBtn.onclick = ()=> openTest(t.id);
        delBtn.onclick = ()=> { savedTests = savedTests.filter(x=>x.id!==t.id); persistAll(); renderSaved(); };
        actions.appendChild(openBtn); actions.appendChild(delBtn);
        li.appendChild(actions);
        testsList.appendChild(li);
      });
    }

    function openTest(id){
      const t = savedTests.find(x=>x.id===id);
      if(!t) return;
      titleEl.value = t.title;
      state.questions = t.questions.slice();
      state.pool = t.questions.slice();
      state.currentTestId = t.id;
      state.locked.clear();
      questionCountEl.value = t.questions.length;
      renderQuestions(state.questions);
      saveBtn.disabled = false;
      regenBtn.disabled = false;
      setStatus("Test caricato. Modifica e salva per aggiornare.");
    }

    function persistAll() {
      saveJSON(STORAGE_TESTS, savedTests);
      saveJSON(STORAGE_RESULTS, savedResults);
      saveJSON(STORAGE_STUDENTS, students);
      saveJSON(STORAGE_REQUESTS, requests);
      saveRemote("vvf_tests", savedTests);
      saveRemote("vvf_results", savedResults);
      saveRemote("vvf_students", students);
      saveRemote("vvf_requests", requests);
    }
  </script>
</body>
</html>
